generator client {
  provider = "prisma-client-js"
  previewFeatures = ["tracing", "metrics"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model User {
    id                      BigInt          @id @default(autoincrement())
    userId                  String          @unique
    roleId                  Int
    username                String          @unique
    password                String
    email                   String?
    lastActivityDate        DateTime?       @db.Timestamp(6)
    createdAt               DateTime        @default(now()) @db.Timestamp(6)
    updatedAt               DateTime        @updatedAt @db.Timestamp(6)

    // Table inheritance
    admin                   Admin?           
    lecturer                Lecturer?
    student                 Student?

    refreshToken            RefreshToken?   
    role                    Role            @relation(fields: [roleId], references: [id], onUpdate: Cascade)
    sentNotifications       Notification[]
    receivedNotifications   Notification[]  @relation("usersReceivedNotifications")
}

model RefreshToken {
    id      BigInt      @id @default(autoincrement())
    userId  String      @unique
    token   String      @db.VarChar(255)
    exp     DateTime    @db.Timestamp(6)

    user    User        @relation(fields: [userId], references: [userId], onUpdate: Cascade, onDelete: Cascade)
}

model Role {
    id              Int         @id @default(autoincrement())
    name            String      @unique
    description     String?
    createdAt       DateTime    @default(now()) @db.Timestamp(6)
    updatedAt       DateTime    @updatedAt @db.Timestamp(6)
    
    users           User[]
}

model Notification {
    id          BigInt      @id @default(autoincrement())
    senderId    String?
    title       String?     @db.VarChar(255)
    content     String?     @db.Text
    isRead      Boolean     @default(false)
    createdAt   DateTime    @default(now()) @db.Timestamp(6)
    updatedAt   DateTime    @updatedAt @db.Timestamp(6)

    sender      User?       @relation(fields: [senderId], references: [userId], onDelete: Cascade, onUpdate: Cascade)
    receivers   User[]      @relation("usersReceivedNotifications")
}

model Admin {
    id                            BigInt                        @id @default(autoincrement())
    userId                        String                        @unique
    contact                       String?                       @db.VarChar(255)
    title                         String?                       @db.VarChar(255)
    signature                     String?                       @db.VarChar(255)

    user                          User                          @relation(fields: [userId], references: [userId], onDelete: Cascade, onUpdate: Cascade)                        
    bachelorThesisRegistrations   BachelorThesisRegistration[]
    oralDefenseRegistrations      OralDefenseRegistration[]
}

model Lecturer {
    id                               BigInt                          @id @default(autoincrement())
    userId                           String                          @unique
    title                            String?                         @db.VarChar(255)
    numberOfTheses                   Int                             @default(0)
    bio                              String?                         @db.MediumText
    signature                        String?                         @db.VarChar(255)

    user                             User                            @relation(fields: [userId], references: [userId], onDelete: Cascade, onUpdate: Cascade)
    sup1BachelorThesisRegistrations  BachelorThesisRegistration[]    @relation("supervisor1BachelorThesisRegistrations")
    sup2BachelorThesisRegistrations  BachelorThesisRegistration[]    @relation("supervisor2BachelorThesisRegistrations")
    supBachelorThesisEvaluations     BachelorThesisEvaluation[]      @relation("supervisorBachelorThesisEvaluations")
    sup1OralDefenseRegistrations     OralDefenseRegistration[]       @relation("supervisor1OralDefenseRegistrations")
    sup2OralDefenseRegistrations     OralDefenseRegistration[]       @relation("supervisor2OralDefenseRegistrations")
    sup1BachelorThesisAssessments    BachelorThesisAssessment[]      @relation("supervisor1BachelorThesisAssessments")
    sup2BachelorThesisAssessments    BachelorThesisAssessment[]      @relation("supervisor2BachelorThesisAssessments")
    sup1OralDefenseAssessments       OralDefenseAssessment[]         @relation("supervisor1OralDefenseAssessments")
    sup2OralDefenseAssessments       OralDefenseAssessment[]         @relation("supervisor2OralDefenseAssessments")
}

model Program {
    id              Int         @id @default(autoincrement())
    title           String      @unique @db.VarChar(255)
    description     String?     @db.Text
    createdAt       DateTime    @default(now()) @db.Timestamp(6)
    updatedAt       DateTime    @updatedAt @db.Timestamp(6)

    students        Student[]
}

model Student {
    id                            BigInt                          @id @default(autoincrement())
    userId                        String                          @unique
    programId                     Int?
    surname                       String?                         @db.VarChar(255)
    forename                      String?                         @db.VarChar(255)                            
    intake                        Int?
    ects                          Int                             @default(0)
    signature                     String?                         @db.VarChar(255)

    user                          User                            @relation(fields: [userId], references: [userId], onDelete: Cascade, onUpdate: Cascade)
    program                       Program?                        @relation(fields: [programId], references: [id], onDelete: SetNull, onUpdate: Cascade)
    bachelorThesisRegistration    BachelorThesisRegistration?
    oralDefenseRegistration       OralDefenseRegistration?
    bachelorThesisAssessment      BachelorThesisAssessment?
    oralDefenseAssessment         OralDefenseAssessment?
    bachelorThesisEvaluation      BachelorThesisEvaluation?
}

model Topic {
    id              Int         @id @default(autoincrement())
    title           String      @db.VarChar(255)
    description     String?     @db.Text
    createdAt       DateTime    @default(now()) @db.Timestamp(6)
    updatedAt       DateTime    @updatedAt @db.Timestamp(6)

    theses          Thesis[]
}

model Field {
    id              Int         @id @default(autoincrement())
    title           String      @db.VarChar(255)
    description     String?     @db.Text
    createdAt       DateTime    @default(now()) @db.Timestamp(6)
    updatedAt       DateTime    @updatedAt @db.Timestamp(6)

    theses          Thesis[]
}
        
model Thesis {
    id                            BigInt                              @id @default(autoincrement())
    topicId                       Int?
    fieldId                       Int?
    title                         String?                             @db.VarChar(255)       
    slot                          Int                                 @default(0)
    slotLimit                     Int?                                @default(2)
    activateRegistration          Boolean                             @default(false)
    activateDefense               Boolean                             @default(false)
    submissionDeadline            DateTime?                           @db.DateTime
    numberHardCopies              Int?                
    printRequirements             String?                             @db.VarChar(255)
    templateFiles                 String?                             @db.VarChar(255)
    createdAt                     DateTime                            @default(now()) @db.Timestamp(6)
    updatedAt                     DateTime                            @updatedAt @db.Timestamp(6)

    topic                         Topic?                              @relation(fields: [topicId], references: [id])
    field                         Field?                              @relation(fields: [fieldId], references: [id])
    bachelorThesisRegistrations   BachelorThesisRegistration[]
    oralDefenseRegistrations      OralDefenseRegistration[]
    bachelorThesisAssessments     BachelorThesisAssessment[]
    oralDefenseAssessments        OralDefenseAssessment[]
    bachelorThesisEvaluations     BachelorThesisEvaluation[]
}

model Location {
    id                  Int             @id @default(autoincrement())
    title               String          @db.VarChar(255)
    description         String?         @db.Text
    createdAt           DateTime        @default(now()) @db.Timestamp(6)
    updatedAt           DateTime        @updatedAt @db.Timestamp(6)
}

model BachelorThesisRegistration {
    id                      BigInt      @id @default(autoincrement())
    thesisId                BigInt
    studentId               String      @unique
    supervisor1Id           String?
    supervisor2Id           String?
    adminId                 String?
    dateOfBirth             DateTime?   @db.Date
    placeOfBirth            String?     @db.VarChar(255)
    studentDate             DateTime?   @db.Date
    furtherParticipants     String?     @db.Text
    supervisor1Date         DateTime?   @db.Date
    supervisor1Confirmed    Boolean?    
    supervisor2Date         DateTime?   @db.Date
    supervisor2Confirmed    Boolean?
    adminConfirmed          Boolean?
    adminAllowed            Boolean?    
    issued                  DateTime?   @db.Date
    deadlineCopy            DateTime?   @db.Date
    extensionGranted        DateTime?   @db.Date
    chairmanOfExamination   String?     @db.VarChar(255)
    dateOfIssue             DateTime?   @db.Date
    createdAt               DateTime    @default(now()) @db.Timestamp(6)
    updatedAt               DateTime    @updatedAt @db.Timestamp(6)

    student                 Student     @relation(fields: [studentId], references: [userId], onDelete: Cascade, onUpdate: Cascade)
    thesis                  Thesis      @relation(fields: [thesisId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    supervisor1             Lecturer?   @relation("supervisor1BachelorThesisRegistrations", fields: [supervisor1Id], references: [userId], onDelete: Cascade, onUpdate: Cascade)
    supervisor2             Lecturer?   @relation("supervisor2BachelorThesisRegistrations", fields: [supervisor2Id], references: [userId], onDelete: Cascade, onUpdate: Cascade)
    admin                   Admin?      @relation(fields: [adminId], references: [userId], onDelete: Cascade, onUpdate: Cascade)
}

model OralDefenseRegistration {
    id                     BigInt         @id @default(autoincrement())
    studentId              String      @unique
    thesisId               BigInt
    supervisor1Id          String?
    supervisor2Id          String?
    adminId                String?
    room                   String?     @db.Text
    areSpectatorsAllowed   Boolean?    
    proposedDate           DateTime?   @db.DateTime
    actualDate             DateTime?   @db.DateTime
    concernedAgreed        Int?        @default(0)
    dateReceived           DateTime?   @db.DateTime
    admissionDate          DateTime?   @db.DateTime
    adminAllowed           Boolean?
    createdAt              DateTime    @default(now()) @db.Timestamp(6)
    updatedAt              DateTime    @updatedAt @db.Timestamp(6)

    student                Student     @relation(fields: [studentId], references: [userId], onDelete: Cascade, onUpdate: Cascade)
    thesis                 Thesis      @relation(fields: [thesisId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    supervisor1            Lecturer?   @relation("supervisor1OralDefenseRegistrations", fields: [supervisor1Id], references: [userId], onDelete: SetNull, onUpdate: Cascade)
    supervisor2            Lecturer?   @relation("supervisor2OralDefenseRegistrations", fields: [supervisor2Id], references: [userId], onDelete: SetNull, onUpdate: Cascade)
    admin                  Admin?      @relation(fields: [adminId], references: [userId], onDelete: SetNull, onUpdate: Cascade)
}

model BachelorThesisAssessment {
    id                     BigInt      @id @default(autoincrement())
    studentId              String      @unique
    thesisId               BigInt
    supervisor1Id          String?
    supervisor2Id          String?
    furtherParticipants    String?     @db.VarChar(255)
    supervisor1Grade       Float?      @db.Float
    supervisor2Grade       Float?      @db.Float
    assessmentDescription  String?     @db.VarChar(255)
    assessmentDate         DateTime?   @db.Date
    createdAt              DateTime    @default(now()) @db.Timestamp(6)
    updatedAt              DateTime    @updatedAt @db.Timestamp(6)

    student                Student     @relation(fields: [studentId], references: [userId], onDelete: Cascade, onUpdate: Cascade)
    thesis                 Thesis      @relation(fields: [thesisId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    supervisor1            Lecturer?   @relation("supervisor1BachelorThesisAssessments", fields: [supervisor1Id], references: [userId], onDelete: SetNull, onUpdate: Cascade)
    supervisor2            Lecturer?   @relation("supervisor2BachelorThesisAssessments", fields: [supervisor2Id], references: [userId], onDelete: SetNull, onUpdate: Cascade)
}

model OralDefenseAssessment {
    id                     BigInt      @id @default(autoincrement())
    studentId              String      @unique
    thesisId               BigInt
    supervisor1Id          String?
    supervisor2Id          String?
    dateDefense            DateTime?   @db.Date
    placeDefense           String?     @db.VarChar(255)
    startDate              DateTime?   @db.Date
    finishDate             DateTime?   @db.Date
    stateOfHealth          Boolean?
    supervisor1Grade       Float?      @db.Float
    supervisor2Grade       Float?      @db.Float
    record                 String?     @db.Text
    assessmentDate         DateTime?   @db.Date
    createdAt              DateTime    @default(now()) @db.Timestamp(6)
    updatedAt              DateTime    @updatedAt @db.Timestamp(6)

    student                Student     @relation(fields: [studentId], references: [userId], onDelete: Cascade, onUpdate: Cascade)
    thesis                 Thesis      @relation(fields: [thesisId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    supervisor1            Lecturer?   @relation("supervisor1OralDefenseAssessments", fields: [supervisor1Id], references: [userId], onDelete: SetNull, onUpdate: Cascade)
    supervisor2            Lecturer?   @relation("supervisor2OralDefenseAssessments", fields: [supervisor2Id], references: [userId], onDelete: SetNull, onUpdate: Cascade)
}

model BachelorThesisEvaluation {
    id                      BigInt      @id @default(autoincrement())
    thesisId                BigInt
    studentId               String      @unique
    supervisorId            String
    title                   String?     @db.VarChar(255)
    date                    DateTime?   @db.Date
    supervisorConfirmed     Boolean?    
    createdAt               DateTime    @default(now()) @db.Timestamp(6)
    updatedAt               DateTime    @updatedAt @db.Timestamp(6)

    student                 Student     @relation(fields: [studentId], references: [userId], onDelete: Cascade, onUpdate: Cascade)
    thesis                  Thesis      @relation(fields: [thesisId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    supervisor              Lecturer    @relation("supervisorBachelorThesisEvaluations", fields: [supervisorId], references: [userId], onDelete: Cascade, onUpdate: Cascade)
}